<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="im.vinci.website.persistence.OrderMapper">
    <!--检索结果列 -->
    <sql id="orderColumns">
        orders.version,orders.order_status,DATE_FORMAT(orders.dt_create,'%Y-%m-%d %H:%i:%s') as dt_create,spec.product_id,orders.order_id,spec.product_count,orders.address,
            invo.category,invo.title,orders.payment_method,orders.payment_status,orders.act_total_payment,spec.remark
    </sql>
    <!-- 查询条件 完整订单信息查询-->
    <sql id="orderConditon">
        where 1=1
        AND orders.order_id = spec.order_id
        AND invo.order_id = spec.order_id
        <if test="from_create_date!=null and from_create_date!=''">
            and    <![CDATA[ orders.dt_create > #{dt_create}]]>
        </if>
        <if test="to_create_date!=null and to_create_date!=''">
            and    <![CDATA[ orders.dt_create < #{to_create_date}]]>
        </if>
        <if test="order_status!=null and order_status.size>0">
            and orders.order_status
            IN
            <foreach collection="order_status" item="order_status1" index="index"
                     open="(" close=")" separator=",">
                #{order_status1}
            </foreach>
        </if>
        <if test="product_id!=null and product_id.size>0">
            and spec.product_id
            IN
            <foreach collection="product_id" item="product_id1" index="index"
                     open="(" close=")" separator=",">
                #{product_id1}
            </foreach>
        </if>
        <if test="invoice_category!=null and invoice_category.size>0">
            and invo.category
            IN
            <foreach collection="invoice_category" item="invoice_category1" index="index"
                     open="(" close=")" separator=",">
                #{invoice_category1}
            </foreach>
        </if>
        <if test="payment_method!=null and payment_method.size>0">
            and orders.payment_method
            IN
            <foreach collection="payment_method" item="payment_method1" index="index"
                     open="(" close=")" separator=",">
                #{payment_method1}
            </foreach>
        </if>
        <!--   <if test="statuses!=null and statuses.size>0">
            and status
            IN
            <foreach collection="statuses" item="status" index="index"
                     open="(" close=")" separator=",">
                #{status}
            </foreach>
         </if>-->
    </sql>
    <!--修改订单-->
    <sql id="OrderUpdateCondition">
        <if test="payment_status!=null and payment_status!=''">
            SET payment_status = #{payment_status}
        </if>
        <if test="payment_method!=null and payment_method!=''">
            SET payment_method = #{paymentmethod}
        </if>
        <if test="total_payment!=null and tatal_payment!=''">
            SET total_payment = #{total_payment}
        </if>
        <if test="act_total_payment!=null and act_total_payment!=''">
            SET act_total_payment = #{act_total_payment}
        </if>
        <if test="discount_code!=null and discount_code!=''">
            SET discount_code = #{discount_code}
        </if>
        <if test="address!=null and address!=''">
            SET address = #{address}
        </if>
        <if test="version!=null and version!=''">
            SET version = #{version}+1
        </if>
        <if test="order_status!=null and order_status!=''">
            SET order_status = #{order_status}
        </if>
    </sql>
    <!--修改订单详情-->
    <sql id="OrderSpecUpdateCondition">
        <if test="product_price!=null and product_price!=''">
            SET product_price = #{product_price}
        </if>
        <if test="product_count!=null and product_count!=''" >
            SET product_count = #{product_count}
        </if>
        <if test="act_payment!=null and act_payment!=''">
            SET act_payment = #{act_payment}
        </if>
        <if test="discount_code!=null and discount_code!=''">
            SET discount_code = #{discount_code}
        </if>
        <if test="remark!=null and remark!=''">
            SET remark  = #{remark}
        </if>

    </sql>
    <!--修改发票信息-->
    <sql id="InvoiceUpdateCondition">
        <if test="category!=null and cotegory!=''">
            SET category = #{category}
        </if>
        <if test="title!=null and title!=''">
            SET title = #{title}
        </if>
        <if test="tax_num!=null and tax_num!=''">
            SET tax_num = #{tax_num}
        </if>
        <if test="address!=null and address!=''">
            SET address = #{address}
        </if>
        <if test="phone!=null and phone!=''">
            SET  phone =#{phone}
        </if>
        <if test="bank!=null and bank!=''">
            SET bank = #{bank}
        </if>
        <if test="bank_account_number!=null and bank_account_number!=''">
            SET bank_account_number = #{bank_account_number}
        </if>
        <if test="price!=null and price!=''">
            SET price = #{price}
        </if>
    </sql>

    <select id="getOrderList" parameterType="dto" resultType="dto">
        select
        <include refid="orderColumns"/>
        from
        user_order orders,user_order_spec spec,invoice invo
        <include refid="orderConditon"/>;
    </select>

    <!--查询订单操作日志-->
    <select id="getChangeLog" parameterType="dto" resultType="dto">
        select
        operator,operator_type,body,DATE_FORMAT(dt_create,'%Y-%m-%d %H:%i:%s') as dt_create
        from
        user_order_changelog log
        WHERE
        1=1
        <if test="order_id!=null and order_id!=''">
            AND order_id = #{order_id}
        </if>
    </select>

    <!--修改订单信息-->
    <update id="doUpdateOrderById" parameterType="dto" >
      update
        user_order
        <include refid="OrderUpdateCondition"/>
      where
       1 =1
       AND order_id = #{order_id}#
       AND version = #{version}#
    </update>
    <!--修改订单详情-->
    <update id="doUpdateOrderSpecByOrderId" parameterType="dto">
        update
          user_order_spec
          <include refid="OrderSpecUpdateCondition"/>
        WHERE
           1=1
          AND order_id = #{order_id}
    </update>

    <update id="doUpdateInvoiceByOrderId" parameterType="dto">
        UPDATE
          invoice
        <include refid="InvoiceUpdateCondition"/>
        WHERE
            1=1
            AND order_id = #{order_id}
    </update>

</mapper>